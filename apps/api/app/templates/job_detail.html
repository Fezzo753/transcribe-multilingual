{% extends "base.html" %}
{% block title %}Job {{ job.id }} | Transcribe Multilingual{% endblock %}
{% block content %}
<div class="card">
  <h2>Job {{ job.id }}</h2>
  <p>
    Status:
    {% if job.status == "completed" %}
    <span class="pill ok" id="job-status">{{ job.status }}</span>
    {% elif job.status == "failed" %}
    <span class="pill fail" id="job-status">{{ job.status }}</span>
    {% else %}
    <span class="pill" id="job-status">{{ job.status }}</span>
    {% endif %}
  </p>
  <p class="muted">Provider: {{ job.provider }} / {{ job.model }}</p>
  <div class="actions">
    <a href="/api/jobs/{{ job.id }}/bundle.zip"><button class="secondary" style="width: auto;">Download Bundle</button></a>
    <button class="danger" style="width: auto;" onclick="cancelJob()">Cancel Job</button>
  </div>
</div>

<div class="card">
  <h3>Files</h3>
  <table id="files-table">
    <thead>
      <tr>
        <th>Input</th>
        <th>Status</th>
        <th>Language</th>
        <th>Warnings</th>
        <th>Artifacts</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const jobId = "{{ job.id }}";

function renderFileRow(file) {
  const links = file.artifacts.map((artifact) =>
    `<a href="/api/jobs/${jobId}/artifacts/${artifact.id}">${artifact.name}</a>`
  ).join("<br/>");
  const warning = file.translation_warning_message || file.error_message || "";
  return `<tr>
    <td>${file.input_name}</td>
    <td>${file.status}</td>
    <td>${file.detected_language || ""}</td>
    <td>${warning}</td>
    <td>${links}</td>
  </tr>`;
}

function render(data) {
  document.getElementById("job-status").textContent = data.status;
  const tbody = document.querySelector("#files-table tbody");
  tbody.innerHTML = data.files.map(renderFileRow).join("");
}

async function fetchJob() {
  const res = await fetch(`/api/jobs/${jobId}`);
  if (!res.ok) {
    return;
  }
  const data = await res.json();
  render(data);
  if (!["completed", "failed", "cancelled"].includes(data.status)) {
    setTimeout(fetchJob, 3000);
  }
}

async function cancelJob() {
  const res = await fetch(`/api/jobs/${jobId}/cancel`, { method: "POST" });
  if (!res.ok) {
    alert(await res.text());
    return;
  }
  fetchJob();
}

fetchJob();
</script>
{% endblock %}
