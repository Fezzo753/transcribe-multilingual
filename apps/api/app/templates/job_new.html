{% extends "base.html" %}
{% block title %}New Job | Transcribe Multilingual{% endblock %}
{% block content %}
<div class="card">
  <h2>Create Batch Job</h2>
  <div class="grid two">
    <div>
      <label for="provider">Provider</label>
      <select id="provider"></select>
    </div>
    <div>
      <label for="model">Model</label>
      <select id="model"></select>
    </div>
    <div>
      <label for="source_language">Source Language</label>
      <input id="source_language" value="auto" />
    </div>
    <div>
      <label for="timestamp_level">Timestamp Level</label>
      <select id="timestamp_level">
        <option value="segment" selected>Segment</option>
        <option value="word">Word</option>
      </select>
    </div>
    <div>
      <label for="batch_label">Batch Label</label>
      <input id="batch_label" placeholder="Optional" />
    </div>
    <div>
      <label for="translation_enabled">Translation</label>
      <select id="translation_enabled">
        <option value="true" selected>Enabled</option>
        <option value="false">Disabled</option>
      </select>
    </div>
    <div>
      <label for="target_language">Target Language</label>
      <input id="target_language" placeholder="Optional, e.g. fr" />
    </div>
    <div>
      <label for="diarization_enabled">Diarization</label>
      <select id="diarization_enabled">
        <option value="false" selected>Disabled</option>
        <option value="true">Enabled</option>
      </select>
    </div>
    <div>
      <label for="speaker_count">Speaker Count</label>
      <input id="speaker_count" type="number" placeholder="Optional" />
    </div>
    <div>
      <label for="verbose_output">Verbose Output</label>
      <select id="verbose_output">
        <option value="false" selected>Disabled</option>
        <option value="true">Enabled (include provider raw metadata in JSON)</option>
      </select>
    </div>
  </div>

  <h3>Output Formats</h3>
  <div class="grid two">
    <label><input class="format-checkbox" type="checkbox" value="srt" checked /> SRT</label>
    <label><input class="format-checkbox" type="checkbox" value="vtt" checked /> VTT</label>
    <label><input class="format-checkbox" type="checkbox" value="html" checked /> HTML</label>
    <label><input class="format-checkbox" type="checkbox" value="txt" checked /> TXT</label>
    <label><input class="format-checkbox" type="checkbox" value="json" checked /> JSON</label>
  </div>
  <p class="muted" id="model-capability-note"></p>

  <h3>Upload Files</h3>
  <input id="files" type="file" multiple />
  <div class="actions" style="margin-top: 12px;">
    <button id="submit-upload">Submit Upload Job</button>
  </div>

  {% if app_mode == "local" %}
  <h3>Local Folder Batch</h3>
  <input id="folder_path" type="text" placeholder="C:\path\to\media" />
  <div class="actions" style="margin-top: 12px;">
    <button class="secondary" id="submit-folder">Submit Folder Job</button>
  </div>
  {% endif %}
</div>

<script>
const capabilities = {{ capabilities | tojson }};
const providerSelect = document.getElementById("provider");
const modelSelect = document.getElementById("model");
const diarizationSelect = document.getElementById("diarization_enabled");
const speakerCountInput = document.getElementById("speaker_count");
const translationSelect = document.getElementById("translation_enabled");
const targetLanguageInput = document.getElementById("target_language");
const capabilityNote = document.getElementById("model-capability-note");
const formatCheckboxes = Array.from(document.querySelectorAll(".format-checkbox"));

for (const provider of capabilities.providers) {
  const option = document.createElement("option");
  option.value = provider.provider;
  option.textContent = provider.provider;
  providerSelect.appendChild(option);
}

function syncModels() {
  const selectedProvider = providerSelect.value;
  const provider = capabilities.providers.find((item) => item.provider === selectedProvider);
  modelSelect.innerHTML = "";
  for (const model of provider.models) {
    const option = document.createElement("option");
    option.value = model.id;
    option.textContent = model.id;
    modelSelect.appendChild(option);
  }
  applyModelCapabilities();
}

function selectedModelCapability() {
  const selectedProvider = providerSelect.value;
  const selectedModel = modelSelect.value;
  const provider = capabilities.providers.find((item) => item.provider === selectedProvider);
  if (!provider) return null;
  return provider.models.find((item) => item.id === selectedModel) || null;
}

function applyModelCapabilities() {
  const capability = selectedModelCapability();
  if (!capability) return;
  diarizationSelect.disabled = !capability.supports_diarization;
  if (!capability.supports_diarization) {
    diarizationSelect.value = "false";
  }

  const speakerAllowed = capability.supports_diarization && capability.supports_speaker_count && diarizationSelect.value === "true";
  speakerCountInput.disabled = !speakerAllowed;
  if (!speakerAllowed) {
    speakerCountInput.value = "";
  }

  capabilityNote.textContent =
    `Max duration: ${capability.max_duration_sec}s | Max size: ${capability.max_size_mb}MB | ` +
    `Diarization: ${capability.supports_diarization ? "yes" : "no"} | ` +
    `Auto language: ${capability.supports_auto_language ? "yes" : "no"}`;
}

function toggleTranslationFields() {
  const enabled = translationSelect.value === "true";
  targetLanguageInput.disabled = !enabled;
  if (!enabled) {
    targetLanguageInput.value = "";
  }
}

function selectedFormats() {
  return formatCheckboxes.filter((item) => item.checked).map((item) => item.value);
}

function basePayload() {
  const formats = selectedFormats();
  if (!formats.length) {
    throw new Error("Select at least one output format.");
  }
  return {
    provider: providerSelect.value,
    model: modelSelect.value,
    source_language: document.getElementById("source_language").value || "auto",
    target_language: targetLanguageInput.value || null,
    formats: formats.join(","),
    diarization_enabled: document.getElementById("diarization_enabled").value === "true",
    speaker_count: document.getElementById("speaker_count").value || "",
    translation_enabled: translationSelect.value === "true",
    sync_preferred: true,
    timestamp_level: document.getElementById("timestamp_level").value,
    verbose_output: document.getElementById("verbose_output").value === "true",
    batch_label: document.getElementById("batch_label").value || "",
  };
}

providerSelect.addEventListener("change", syncModels);
modelSelect.addEventListener("change", applyModelCapabilities);
diarizationSelect.addEventListener("change", applyModelCapabilities);
translationSelect.addEventListener("change", toggleTranslationFields);
syncModels();
toggleTranslationFields();

document.getElementById("submit-upload").addEventListener("click", async () => {
  const filesInput = document.getElementById("files");
  if (!filesInput.files.length) {
    alert("Select one or more files.");
    return;
  }
  let payload;
  try {
    payload = basePayload();
  } catch (error) {
    alert(error.message || String(error));
    return;
  }
  const form = new FormData();
  for (const file of filesInput.files) {
    form.append("files", file);
  }
  for (const [k, v] of Object.entries(payload)) {
    if (v !== null && v !== undefined) {
      form.append(k, String(v));
    }
  }
  const res = await fetch("/api/jobs", { method: "POST", body: form });
  if (!res.ok) {
    alert(await res.text());
    return;
  }
  const job = await res.json();
  location.href = `/jobs/${job.id}`;
});

const folderButton = document.getElementById("submit-folder");
if (folderButton) {
  folderButton.addEventListener("click", async () => {
    const folderPath = document.getElementById("folder_path").value;
    if (!folderPath) {
      alert("Enter a folder path.");
      return;
    }
    let payload;
    try {
      payload = basePayload();
    } catch (error) {
      alert(error.message || String(error));
      return;
    }
    payload.formats = selectedFormats();
    payload.folder_path = folderPath;
    payload.files_count = 1;
    const res = await fetch("/api/jobs/from-folder", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      alert(await res.text());
      return;
    }
    const job = await res.json();
    location.href = `/jobs/${job.id}`;
  });
}
</script>
{% endblock %}
